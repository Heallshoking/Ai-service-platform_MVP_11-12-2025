#!/usr/bin/expect -f
set timeout 120

puts "\nüöÄ –î–µ–ø–ª–æ–π –±–æ—Ç–∞ @Baltset39_bot\n"

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª
puts "üì¶ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞..."
spawn scp -o StrictHostKeyChecking=no telegram_lead_bot.py root@176.98.178.109:/root/baltset_bot.py
expect "password:"
send "pneDRE2K?Tz1k-\r"
expect eof
puts "‚úÖ –§–∞–π–ª —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω\n"

# SSH –∏ –∑–∞–ø—É—Å–∫
puts "üöÄ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ VPS..."
spawn ssh -o StrictHostKeyChecking=no root@176.98.178.109
expect "password:"
send "pneDRE2K?Tz1k-\r"

expect "#"
puts "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ\n"

send "pkill -f baltset_bot.py 2>/dev/null || true\r"
expect "#"

send "pkill -f telegram_lead_bot.py 2>/dev/null || true\r"
expect "#"
puts "‚úÖ –°—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã\n"

send "pip3 --version > /dev/null 2>&1 || apt-get install -y python3-pip -qq\r"
expect "#"

send "pip3 install python-telegram-bot==13.15 -q\r"
expect "#"
puts "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã\n"

send "cd /root\r"
expect "#"

send "nohup python3 baltset_bot.py > baltset_bot.log 2>&1 &\r"
expect "#"
puts "‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–µ\n"

send "sleep 3\r"
expect "#"

send "pgrep -f baltset_bot.py\r"
expect {
    -re "(\[0-9\]+)" {
        puts "\n================================"
        puts "‚úÖ –ë–û–¢ –£–°–ü–ï–®–ù–û –ó–ê–ü–£–©–ï–ù!"
        puts "================================"
        puts "\nPID: $expect_out(1,string)"
        puts "\nüì± https://t.me/Baltset39_bot"
        puts "üí¨ –ù–∞–ø–∏—à–∏—Ç–µ /start\n"
    }
    "#" {
        puts "\n‚ö†Ô∏è  –ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏..."
        send "tail -20 baltset_bot.log\r"
        expect "#"
    }
}

send "exit\r"
expect eof

puts "\nüéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!\n"
