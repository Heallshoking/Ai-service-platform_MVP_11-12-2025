#!/usr/bin/expect -f
# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ñ Ð¿Ð°Ñ€Ð¾Ð»ÐµÐ¼
set timeout 120
set password "pneDRE2K?Tz1k-"
set vps "176.98.178.109"

puts "\nðŸš€ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Telegram Ð±Ð¾Ñ‚Ð° @Baltset39_bot Ð½Ð° VPS\n"

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ telegram_lead_bot.py
puts "ðŸ“¦ ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ telegram_lead_bot.py..."
spawn scp -o StrictHostKeyChecking=no telegram_lead_bot.py root@$vps:/root/
expect {
    "password:" { send "$password\r" }
    timeout { puts "âŒ Timeout"; exit 1 }
}
expect eof

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ .env
puts "ðŸ“¦ ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ .env..."
spawn scp -o StrictHostKeyChecking=no .env root@$vps:/root/
expect {
    "password:" { send "$password\r" }
    timeout { puts "âŒ Timeout"; exit 1 }
}
expect eof

puts "\nðŸ“¦ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°...\n"

# SSH Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°
spawn ssh -o StrictHostKeyChecking=no root@$vps
expect {
    "password:" { send "$password\r" }
    timeout { puts "âŒ Timeout"; exit 1 }
}

expect "# "
send "cd /root && mkdir -p baltset_bot && mv telegram_lead_bot.py baltset_bot/ && mv .env baltset_bot/ && cd baltset_bot\r"
expect "# "

send "apt-get update -qq && apt-get install -y python3 python3-pip -qq\r"
expect "# " { puts "âœ… Python ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½" }

send "pip3 install python-telegram-bot==13.15 -q\r"
expect "# " { puts "âœ… Ð‘Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹" }

send "systemctl stop baltset-bot 2>/dev/null || true\r"
expect "# "

send "cat > /etc/systemd/system/baltset-bot.service << 'EOFSERVICE'\r"
send "\[Unit\]\r"
send "Description=BALTSET Telegram Lead Bot\r"
send "After=network.target\r"
send "\r"
send "\[Service\]\r"
send "Type=simple\r"
send "User=root\r"
send "WorkingDirectory=/root/baltset_bot\r"
send "ExecStart=/usr/bin/python3 /root/baltset_bot/telegram_lead_bot.py\r"
send "Restart=always\r"
send "RestartSec=10\r"
send "\r"
send "\[Install\]\r"
send "WantedBy=multi-user.target\r"
send "EOFSERVICE\r"
expect "# " { puts "âœ… Systemd ÑÐµÑ€Ð²Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½" }

send "systemctl daemon-reload\r"
expect "# "

send "systemctl start baltset-bot\r"
expect "# "

send "systemctl enable baltset-bot\r"
expect "# "

send "sleep 3\r"
expect "# "

puts "\n================================"
send "systemctl status baltset-bot --no-pager -l | head -15\r"
expect "# " { puts "================================\n" }

puts "âœ… Ð‘ÐžÐ¢ Ð£Ð¡ÐŸÐ•Ð¨ÐÐž Ð—ÐÐŸÐ£Ð©Ð•Ð!\n"
puts "ðŸ“± ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ: https://t.me/Baltset39_bot"
puts "ðŸ’¬ ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ /start Ð±Ð¾Ñ‚Ñƒ\n"

send "exit\r"
expect eof

puts "\nðŸŽ‰ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½!\n"
