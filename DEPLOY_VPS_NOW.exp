#!/usr/bin/expect -f
# ĞĞ’Ğ¢ĞĞœĞĞ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ™ Ğ”Ğ•ĞŸĞ›ĞĞ™ Ğ‘ĞĞ¢ĞĞ’ Ğ¢ĞĞ›Ğ¬ĞšĞ ĞĞ VPS
set timeout 300

puts "\nğŸš€ Ğ”Ğ•ĞŸĞ›ĞĞ™ Ğ‘ĞĞ¢ĞĞ’ ĞĞ VPS (176.98.178.109)\n"

set vps "176.98.178.109"
set pass "pneDRE2K?Tz1k-"

# ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ±Ğ¾Ñ‚Ñ‹
puts "ğŸ“¤ ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ½Ğ° VPS..."
spawn bash -c "cd /Users/user/Documents/Projects/Github/balt-set.ru && scp telegram_client_bot.py telegram_master_bot.py .env root@176.98.178.109:/root/"
expect {
    "password:" {
        send "$pass\r"
        exp_continue
    }
    "100%" {
        exp_continue
    }
    eof
}

puts "\nâœ… Ğ¤Ğ°Ğ¹Ğ»Ñ‹ ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹\n"

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ½Ğ° VPS
puts "âš™ï¸  ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ½Ğ° VPS...\n"
spawn ssh root@$vps
expect "password:"
send "$pass\r"

expect "#"
send "mkdir -p /root/ai_service_bots && cd /root/ai_service_bots\r"
expect "#"

send "mv /root/telegram_client_bot.py /root/telegram_master_bot.py /root/.env . 2>/dev/null\r"
expect "#"

puts "ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹..."
send "pip3 install python-telegram-bot==20.7 httpx python-dotenv -q\r"
set timeout 90
expect "#"
set timeout 300

puts "\nğŸ›‘ ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ğ²..."
send "pkill -9 -f telegram_client_bot.py; pkill -9 -f telegram_master_bot.py\r"
expect "#"
send "sleep 3\r"
expect "#"

puts "\nğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ¾Ğ²..."
send "nohup python3 telegram_client_bot.py > client.log 2>&1 &\r"
expect "#"
send "nohup python3 telegram_master_bot.py > master.log 2>&1 &\r"
expect "#"

send "sleep 7\r"
expect "#"

puts "\nğŸ“Š ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°:\n"
send "if pgrep -f telegram_client_bot.py > /dev/null; then echo 'âœ… ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ (PID:' \$(pgrep -f telegram_client_bot.py)')'; else echo 'âŒ ĞšĞ»Ğ¸ĞµĞ½Ñ‚ ĞĞ• Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚'; fi\r"
expect "#"

send "if pgrep -f telegram_master_bot.py > /dev/null; then echo 'âœ… ĞœĞ°ÑÑ‚ĞµÑ€ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ (PID:' \$(pgrep -f telegram_master_bot.py)')'; else echo 'âŒ ĞœĞ°ÑÑ‚ĞµÑ€ ĞĞ• Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚'; fi\r"
expect "#"

puts "\nğŸ“‹ ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ»Ğ¾Ğ³Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°:"
send "tail -15 client.log\r"
expect "#"

puts "\nğŸ“‹ ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ»Ğ¾Ğ³Ğ¸ Ğ¼Ğ°ÑÑ‚ĞµÑ€Ğ°:"
send "tail -15 master.log\r"
expect "#"

send "exit\r"
expect eof

puts "\n=================================="
puts "âœ… Ğ”Ğ•ĞŸĞ›ĞĞ™ Ğ—ĞĞ’Ğ•Ğ Ğ¨ĞĞ!"
puts "==================================\n"
puts "ğŸ™‹ ĞšĞ»Ğ¸ĞµĞ½Ñ‚: @ai_service_client_bot"
puts "ğŸ‘· ĞœĞ°ÑÑ‚ĞµÑ€: @ai_service_master_bot"
puts "\nğŸ“± ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ±Ğ¾Ñ‚Ğ¾Ğ² Ğ² Telegram!\n"
