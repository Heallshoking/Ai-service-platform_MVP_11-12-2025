# 🏗️ СХЕМА РАБОТЫ СИСТЕМЫ BALT-SET.RU

## 📊 ОБЩАЯ АРХИТЕКТУРА

```
┌─────────────────────────────────────────────────────────────┐
│                    КЛИЕНТЫ / ПОЛЬЗОВАТЕЛИ                   │
└───────────────┬─────────────────────────────────────────────┘
                │
    ┌───────────┴──────────┬──────────────┬──────────────┐
    │                      │              │              │
┌───▼────┐          ┌─────▼──────┐  ┌───▼────┐    ┌────▼────┐
│  WEB   │          │  TELEGRAM  │  │ PHONE  │    │ DIRECT  │
│ САЙТ   │          │    BOT     │  │  CALL  │    │ MESSAGE │
└───┬────┘          └─────┬──────┘  └───┬────┘    └────┬────┘
    │                     │             │              │
    └─────────────┬───────┴─────────────┴──────────────┘
                  │
         ┌────────▼─────────┐
         │  GOOGLE SHEETS   │◄─── Все заявки хранятся здесь
         │   (База данных)  │
         └────────┬─────────┘
                  │
         ┌────────▼──────────┐
         │ СИСТЕМА           │
         │ АВТОНАЗНАЧЕНИЯ    │◄─── master_notification.py
         └────────┬──────────┘
                  │
    ┌─────────────┴──────────────┐
    │                            │
┌───▼─────────┐         ┌───────▼────────┐
│  МАСТЕР 1   │         │   МАСТЕР 2     │
│ (Telegram)  │         │  (Telegram)    │
└─────────────┘         └────────────────┘
    │                            │
    └─────────────┬──────────────┘
                  │
         ┌────────▼─────────┐
         │   ВЫПОЛНЕНИЕ     │
         │    ЗАКАЗА        │
         └──────────────────┘
```

---

## 🔄 ПОДРОБНЫЙ ПРОЦЕСС РАБОТЫ

### 1️⃣ ПОЛУЧЕНИЕ ЗАЯВКИ

```
КЛИЕНТ СОЗДАЕТ ЗАЯВКУ:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Вариант A: Через Telegram бот
┌────────────────────────────────────────┐
│ 1. Клиент: /start                      │
│ 2. Выбирает: "⚡ Услуги электрика"     │
│ 3. Описывает проблему                  │
│ 4. Указывает адрес                     │
│ 5. Вводит имя                          │
│ 6. Вводит телефон                      │
│ 7. Подтверждает заявку                 │
└────────────────────────────────────────┘
         │
         ↓
┌────────────────────────────────────────┐
│ telegram_client_bot.py                 │
│ - Собирает данные                      │
│ - Валидирует информацию                │
│ - Показывает прогресс-бар              │
└────────────────────────────────────────┘

Вариант B: Через сайт
┌────────────────────────────────────────┐
│ 1. Клиент заходит на app.balt-set.ru  │
│ 2. Заполняет форму на index.html       │
│ 3. Отправляет заявку                   │
└────────────────────────────────────────┘
```

### 2️⃣ СОХРАНЕНИЕ ЗАЯВКИ

```
┌────────────────────────────────────────┐
│ google_sheets_integration.py           │
│                                        │
│ def save_order_from_bot():             │
│   - Генерирует ID заявки               │
│   - Сохраняет в Google Таблицу         │
│   - Возвращает order_id                │
└────────────────────────────────────────┘
         │
         ↓
┌────────────────────────────────────────┐
│ GOOGLE SHEETS                          │
│ Лист "Заявки"                          │
│                                        │
│ ID | Дата | Источник | Имя | Телефон  │
│ 1  | ... | telegram | Юля | +7900...  │
│ 2  | ... | website  | Иван| +7901...  │
└────────────────────────────────────────┘
```

### 3️⃣ УВЕДОМЛЕНИЕ МАСТЕРОВ

```
┌────────────────────────────────────────┐
│ master_notification.py                 │
│                                        │
│ async def notify_masters():            │
│   1. Получает список активных мастеров │
│   2. Формирует милое сообщение         │
│   3. Отправляет ВСЕМ мастерам          │
│   4. Со звуковым уведомлением 🔊       │
└────────────────────────────────────────┘
         │
         ↓
┌────────────────────────────────────────┐
│ 🆕 Новая заявка для вас! 🚀            │
│                                        │
│ 📋 Заказ #123                          │
│ ⏰ Время: 14:29                        │
│                                        │
│ 🔧 Категория: ⚡ Электрика             │
│ 💬 Проблема: Не работает розетка...   │
│ 📍 Адрес: Невского 47                 │
│                                        │
│ 👤 Клиент: Юля                        │
│ 📞 Телефон: +79001234567              │
│                                        │
│ [✅ ПРИНЯТЬ ЗАКАЗ 🚀]                 │
└────────────────────────────────────────┘
```

### 4️⃣ ПРИНЯТИЕ ЗАКАЗА

```
МАСТЕР НАЖИМАЕТ КНОПКУ:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌────────────────────────────────────────┐
│ telegram_master_bot.py                 │
│                                        │
│ async def accept_job():                │
│   - Назначает мастера на заявку        │
│   - Обновляет статус в Google Sheets   │
│   - Уведомляет клиента                 │
└────────────────────────────────────────┘
         │
         ↓
┌────────────────────────────────────────┐
│ GOOGLE SHEETS обновляется:             │
│                                        │
│ Статус: "Новая" → "В работе"          │
│ Мастер: "" → "Петров Пётр"             │
└────────────────────────────────────────┘
```

### 5️⃣ ВЫПОЛНЕНИЕ РАБОТЫ

```
┌────────────────────────────────────────┐
│ МАСТЕР                                 │
│ 1. Связывается с клиентом              │
│ 2. Приезжает на объект                 │
│ 3. Выполняет работу                    │
│ 4. В боте нажимает "✅ Завершить"      │
└────────────────────────────────────────┘
         │
         ↓
┌────────────────────────────────────────┐
│ GOOGLE SHEETS обновляется:             │
│                                        │
│ Статус: "Выполнена"                    │
│ Цена: 2000₽                            │
│ Комиссия 30%: 600₽                     │
│ Дата выполнения: 15.12.2024            │
└────────────────────────────────────────┘
```

---

## 📁 СТРУКТУРА ФАЙЛОВ НА VPS

### Telegram боты (работают на VPS)

```
VPS: root@176.98.178.109
Путь: /root/ai_service_bots/

📁 ai_service_bots/
├── telegram_client_bot.py          ← Бот для клиентов
├── telegram_master_bot.py          ← Бот для мастеров
├── master_notification.py          ← Уведомления мастеров
├── google_sheets_integration.py    ← Интеграция с Google Sheets
├── telegram_folders_integration.py ← Telegram папки
├── .env                            ← Переменные окружения (токены)
└── credentials.json                ← Ключи Google API

Запуск ботов:
├── screen -dmS client_bot python3 telegram_client_bot.py
└── screen -dmS master_bot python3 telegram_master_bot.py
```

### Сайт (работает на VPS через Nginx)

```
VPS: root@176.98.178.109
Путь: /var/www/app.balt-set.ru/

📁 app.balt-set.ru/
├── index.html              ← Главная страница
├── catalog.html            ← Каталог услуг
├── services.html           ← Страница услуг
├── calculator.html         ← Калькулятор стоимости
├── ai-chat.html           ← AI-чат
├── track.html             ← Отслеживание заявок
├── master-dashboard.html  ← Панель мастера
├── admin.html             ← Админ панель
├── order-complete.html    ← Завершение заказа
├── payment.html           ← Оплата
├── products.html          ← Редирект на catalog
└── ... (другие страницы)
```

---

## 🗺️ ОСНОВНЫЕ СТРАНИЦЫ САЙТА

### 🏠 ГЛАВНАЯ СТРАНИЦА
```
URL: https://app.balt-set.ru/
Файл: /var/www/app.balt-set.ru/index.html

ЧТО ЕСТЬ:
• Красивое приветствие с анимацией
• Форма быстрого заказа
• Кнопки быстрых действий:
  - AI-чат
  - Калькулятор
  - Каталог услуг
  - Позвонить
```

### 📋 КАТАЛОГ УСЛУГ
```
URL: https://app.balt-set.ru/catalog.html
Файл: /var/www/app.balt-set.ru/catalog.html

ЧТО ЕСТЬ:
• Все услуги электрика с ценами
• Фильтры по категориям
• Кнопка "Заказать услугу"
• Footer с навигацией
```

### 🔧 УСЛУГИ ЭЛЕКТРИКА
```
URL: https://app.balt-set.ru/services.html
Файл: /var/www/app.balt-set.ru/services.html

ЧТО ЕСТЬ:
• Подробное описание услуг
• Цены
• Примеры работ
• Кнопки заказа
```

### 🧮 КАЛЬКУЛЯТОР
```
URL: https://app.balt-set.ru/calculator.html
Файл: /var/www/app.balt-set.ru/calculator.html

ЧТО ЕСТЬ:
• Интерактивный калькулятор стоимости
• Выбор услуг
• Автоматический расчет цены
• Форма заказа
```

### 💬 AI-ЧАТ
```
URL: https://app.balt-set.ru/ai-chat.html
Файл: /var/www/app.balt-set.ru/ai-chat.html

ЧТО ЕСТЬ:
• Чат-бот для консультаций
• Быстрые ответы на вопросы
• Переадресация к админу
```

### 📍 ОТСЛЕЖИВАНИЕ ЗАЯВОК
```
URL: https://app.balt-set.ru/track.html?id=123
Файл: /var/www/app.balt-set.ru/track.html

ЧТО ЕСТЬ:
• Статус заявки в реальном времени
• Информация о мастере
• История изменений
```

### 👨‍🔧 ПАНЕЛЬ МАСТЕРА
```
URL: https://app.balt-set.ru/master-dashboard.html
Файл: /var/www/app.balt-set.ru/master-dashboard.html

ЧТО ЕСТЬ:
• Список активных заказов
• Статистика заработка
• Управление заказами
```

### 🔐 АДМИН ПАНЕЛЬ
```
URL: https://app.balt-set.ru/admin.html
Файл: /var/www/app.balt-set.ru/admin.html

ЧТО ЕСТЬ:
• Управление заявками
• Статистика
• Управление мастерами
```

---

## 🔑 ВАЖНЫЕ ДАННЫЕ

### VPS Доступ
```
Host: 176.98.178.109
User: root
Password: pneDRE2K?Tz1k-

SSH: ssh root@176.98.178.109
```

### Проверка ботов
```bash
# Список screen сессий
screen -ls

# Подключиться к боту клиентов
screen -r client_bot

# Подключиться к боту мастеров
screen -r master_bot

# Выйти: Ctrl+A, затем D
```

### Логи
```bash
# Проверить процессы
ps aux | grep telegram

# Проверить логи Nginx
tail -f /var/log/nginx/error.log
```

---

## 🎯 ОСНОВНЫЕ КОМПОНЕНТЫ

### 1. Telegram Bot (Клиенты)
```python
# Файл: telegram_client_bot.py
# Функции:
- /start - начало диалога
- Сбор данных заявки (проблема, адрес, имя, телефон)
- Валидация данных
- Прогресс-бар (🟢🟢🟢⚪⚪ 60%)
- Кнопка "Вернуться в меню"
- Сохранение в Google Sheets
- Уведомление мастеров
```

### 2. Telegram Bot (Мастера)
```python
# Файл: telegram_master_bot.py
# Функции:
- Регистрация новых мастеров
- Просмотр новых заказов
- Принятие заказов (кнопка "✅ ПРИНЯТЬ ЗАКАЗ 🚀")
- Управление статусом заказа
- Статистика и заработок
```

### 3. Уведомления
```python
# Файл: master_notification.py
# Функции:
- Получение списка активных мастеров
- Формирование милого сообщения
- Отправка со звуком всем мастерам
- Логирование результатов
```

### 4. Google Sheets
```python
# Файл: google_sheets_integration.py
# Листы:
- "Заявки" - все заявки клиентов
- "Мастера" - список мастеров
- "Статистика" - общая статистика

# Функции:
- save_order_from_bot() - сохранить заявку
- assign_master() - назначить мастера
- complete_order() - завершить заказ
```

---

## 📱 TELEGRAM БОТЫ

```
Клиентский бот:
@ai_service_client_bot
Token: хранится в .env (TELEGRAM_CLIENT_BOT_TOKEN)

Мастерский бот:
@ai_service_master_bot (название может отличаться)
Token: хранится в .env (TELEGRAM_MASTER_BOT_TOKEN)
```

---

## 🚀 ДЕПЛОЙ

### Для обновления ботов:
```bash
# Локально создайте expect скрипт или используйте существующий:
expect deploy_fixes_15_12.exp

# Что происходит:
1. Копирование файлов на VPS
2. Остановка старых ботов (pkill)
3. Запуск новых ботов (screen -dmS)
4. Проверка запуска
```

### Для обновления сайта:
```bash
# Скопировать HTML файлы:
scp static/*.html root@176.98.178.109:/var/www/app.balt-set.ru/

# Перезапустить Nginx:
ssh root@176.98.178.109
systemctl reload nginx
```

---

**ВСЁ РАБОТАЕТ И ГОТОВО К ИСПОЛЬЗОВАНИЮ! 🎉**
